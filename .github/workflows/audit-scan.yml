name: Audit Scan - Discovery & Analysis

# Stage 1-2: Discovery and Analysis
# Scans repository for all issues using free/open-source tools

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  # Check if this is a scheduled/timed run that should execute full scan
  check-trigger:
    name: Check Trigger Type
    runs-on: ubuntu-latest
    outputs:
      should-run-scan: ${{ steps.check.outputs.should-run }}
      trigger-type: ${{ steps.check.outputs.trigger-type }}
      error-occurred: ${{ steps.check.outputs.error-occurred }}
    steps:
      - name: Determine if full scan should run
        id: check
        continue-on-error: true
        run: |
          set -euo pipefail
          
          # Error handling wrapper
          handle_error() {
            local exit_code=$?
            echo "error-occurred=true" >> $GITHUB_OUTPUT
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "trigger-type=error" >> $GITHUB_OUTPUT
            echo "‚ùå Error determining trigger type (exit code: $exit_code)"
            exit 0  # Don't fail the workflow, just log
          }
          trap handle_error ERR
          
          # Validate environment
          if [[ -z "${{ github.event_name }}" ]]; then
            echo "‚ö†Ô∏è Warning: github.event_name is empty, defaulting to false"
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "trigger-type=unknown" >> $GITHUB_OUTPUT
            echo "error-occurred=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Determine trigger type with comprehensive checks
          TRIGGER="${{ github.event_name }}"
          echo "üîç Analyzing trigger: $TRIGGER"
          
          case "$TRIGGER" in
            schedule)
              echo "should-run=true" >> $GITHUB_OUTPUT
              echo "trigger-type=schedule" >> $GITHUB_OUTPUT
              echo "‚úÖ Full audit scan will run (scheduled weekly run)"
              ;;
            workflow_dispatch)
              echo "should-run=true" >> $GITHUB_OUTPUT
              echo "trigger-type=manual" >> $GITHUB_OUTPUT
              echo "‚úÖ Full audit scan will run (manual trigger)"
              ;;
            push)
              echo "should-run=true" >> $GITHUB_OUTPUT
              echo "trigger-type=push" >> $GITHUB_OUTPUT
              echo "‚úÖ Full audit scan will run (push to ${{ github.ref }})"
              ;;
            pull_request|pull_request_target)
              echo "should-run=false" >> $GITHUB_OUTPUT
              echo "trigger-type=pr" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è Audit scan skipped on PR - runs weekly on schedule"
              ;;
            *)
              echo "should-run=false" >> $GITHUB_OUTPUT
              echo "trigger-type=other" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Unknown trigger type: $TRIGGER - defaulting to skip"
              ;;
          esac
          
          echo "error-occurred=false" >> $GITHUB_OUTPUT
          echo "‚úì Trigger analysis complete"
  
  # Pass gracefully on PRs without running scan
  pr-pass:
    name: PR Check - Pass Without Scan
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should-run-scan == 'false'
    steps:
      - name: Pass gracefully on PR
        continue-on-error: false
        run: |
          set -euo pipefail
          
          # Error handling
          handle_error() {
            echo "## ‚ö†Ô∏è Audit Scan Status Warning" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "An error occurred while processing audit scan status." >> $GITHUB_STEP_SUMMARY
            echo "**Fallback**: Passing gracefully - security scans run weekly." >> $GITHUB_STEP_SUMMARY
          }
          trap handle_error ERR
          
          # Get trigger info with fallback
          TRIGGER_TYPE="${{ needs.check-trigger.outputs.trigger-type }}"
          TRIGGER_TYPE="${TRIGGER_TYPE:-unknown}"
          
          echo "## ‚úÖ Audit Scan Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This audit scan only runs on scheduled weekly runs." >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: $TRIGGER_TYPE (scan not required)" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ‚úÖ Passed (security scans run weekly)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Information" >> $GITHUB_STEP_SUMMARY
          echo "- Weekly scheduled scans ensure repository security" >> $GITHUB_STEP_SUMMARY
          echo "- Full scans run on: schedule, manual trigger, push to main/develop" >> $GITHUB_STEP_SUMMARY
          echo "- Next scheduled scan: Every Sunday at midnight UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úì Workflow completed successfully"

  discovery:
    name: Discovery - Enumerate Files
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should-run-scan == 'true'
    outputs:
      file-matrix: ${{ steps.enumerate.outputs.matrix }}
      total-files: ${{ steps.enumerate.outputs.total }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Enumerate source files
        id: enumerate
        continue-on-error: true
        run: |
          set -euo pipefail
          
          # Error handling wrapper
          handle_error() {
            local exit_code=$?
            echo "‚ùå Error during file enumeration (exit code: $exit_code)" >&2
            echo "total=0" >> $GITHUB_OUTPUT
            echo "matrix=[]" >> $GITHUB_OUTPUT
            exit 1  # Fail the step but allow workflow to continue
          }
          trap handle_error ERR
          
          echo "Discovering all source files..."
          
          # Validate current directory
          if [[ ! -d .git ]]; then
            echo "‚ö†Ô∏è Warning: Not in a git repository root"
          fi
          
          # Find all source files with error handling
          files=$(find . -type f \( \
            -name '*.js' -o \
            -name '*.ts' -o \
            -name '*.jsx' -o \
            -name '*.tsx' -o \
            -name '*.json' -o \
            -name '*.yml' -o \
            -name '*.yaml' -o \
            -name '*.md' \
          \) ! -path '*/node_modules/*' ! -path '*/dist/*' ! -path '*/.git/*' 2>/dev/null || echo "")
          
          # Validate results
          if [[ -z "$files" ]]; then
            echo "‚ö†Ô∏è Warning: No files found, using empty list"
            echo "total=0" >> $GITHUB_OUTPUT
            echo "matrix=[]" >> $GITHUB_OUTPUT
            echo "[]" > discovered-files.txt
            exit 0
          fi
          
          total=$(echo "$files" | wc -l)
          echo "total=$total" >> $GITHUB_OUTPUT
          echo "‚úì Found $total source files"
          
          # Create JSON matrix with error handling
          if command -v jq &> /dev/null; then
            matrix=$(echo "$files" | jq -R -s -c 'split("\n") | map(select(length > 0))' 2>/dev/null || echo '[]')
          else
            echo "‚ö†Ô∏è Warning: jq not found, using empty matrix"
            matrix='[]'
          fi
          
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          
          # Save file list as artifact with error handling
          echo "$files" > discovered-files.txt || echo "‚ö†Ô∏è Warning: Could not write file list"
          
          echo "‚úì File enumeration complete"
      
      - name: Upload file list
        uses: actions/upload-artifact@v5
        with:
          name: discovered-files
          path: discovered-files.txt
          retention-days: 7

  static-analysis:
    name: Analysis - Static Code Analysis
    runs-on: ubuntu-latest
    needs: [check-trigger, discovery]
    if: needs.check-trigger.outputs.should-run-scan == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint (Free)
        continue-on-error: true
        run: |
          echo "Running ESLint static analysis..."
          npx eslint . --ext .js,.jsx,.ts,.tsx --format json --output-file eslint-report.json || true
          npx eslint . --ext .js,.jsx,.ts,.tsx --format stylish || true
      
      - name: Run TypeScript Compiler Check (Free)
        continue-on-error: true
        run: |
          echo "Running TypeScript compiler checks..."
          npx tsc --noEmit --pretty > typescript-report.txt 2>&1 || true
          cat typescript-report.txt
      
      - name: Upload static analysis results
        uses: actions/upload-artifact@v5
        with:
          name: static-analysis-results
          path: |
            eslint-report.json
            typescript-report.txt
          retention-days: 7

  security-scan:
    name: Analysis - Security Scanning
    runs-on: ubuntu-latest
    needs: [check-trigger, discovery]
    if: needs.check-trigger.outputs.should-run-scan == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit (Free)
        continue-on-error: true
        run: |
          echo "Running npm security audit..."
          npm audit --json > npm-audit-report.json || true
          npm audit || true
      
      - name: Initialize CodeQL (Free)
        uses: github/codeql-action/init@v4
        with:
          languages: javascript,typescript
          queries: security-and-quality
      
      - name: Perform CodeQL Analysis (Free)
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript"
      
      - name: Upload security scan results
        uses: actions/upload-artifact@v5
        with:
          name: security-scan-results
          path: |
            npm-audit-report.json
          retention-days: 7

  dependency-check:
    name: Analysis - Dependency Health
    runs-on: ubuntu-latest
    needs: [check-trigger, discovery]
    if: needs.check-trigger.outputs.should-run-scan == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Check package.json validity
        run: |
          echo "Validating package.json..."
          if [ -f package.json ]; then
            jq empty package.json && echo "‚úì package.json is valid JSON" || echo "‚úó package.json is invalid JSON"
          fi
      
      - name: Check for dependency conflicts
        run: |
          echo "Checking for dependency conflicts..."
          npm install --dry-run > dependency-check.txt 2>&1 || true
          cat dependency-check.txt
      
      - name: Check for outdated dependencies (Free)
        continue-on-error: true
        run: |
          echo "Checking for outdated dependencies..."
          npm outdated --json > outdated-deps.json || true
          npm outdated || true
      
      - name: Upload dependency check results
        uses: actions/upload-artifact@v5
        with:
          name: dependency-check-results
          path: |
            dependency-check.txt
            outdated-deps.json
          retention-days: 7

  configuration-check:
    name: Analysis - Configuration Validation
    runs-on: ubuntu-latest
    needs: [check-trigger, discovery]
    if: needs.check-trigger.outputs.should-run-scan == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Check TypeScript configuration
        run: |
          echo "Validating TypeScript configuration..."
          if [ -f tsconfig.json ]; then
            jq empty tsconfig.json && echo "‚úì tsconfig.json is valid JSON" || echo "‚úó tsconfig.json is invalid JSON"
          else
            echo "‚ö† No tsconfig.json found"
          fi
      
      - name: Check ESLint configuration
        run: |
          echo "Validating ESLint configuration..."
          if [ -f .eslintrc.json ]; then
            jq empty .eslintrc.json && echo "‚úì .eslintrc.json is valid JSON" || echo "‚úó .eslintrc.json is invalid JSON"
          elif [ -f .eslintrc.js ]; then
            echo "‚úì .eslintrc.js found"
          else
            echo "‚ö† No ESLint configuration found"
          fi
      
      - name: Check environment configuration
        run: |
          echo "Checking environment configuration..."
          [ -f .env.example ] && echo "‚úì .env.example found" || echo "‚ö† No .env.example found"
          [ -f .env ] && echo "‚ö† .env file exists (should be in .gitignore)" || echo "‚úì No .env file in repository"
      
      - name: Validate GitHub workflows
        run: |
          echo "Validating GitHub workflow syntax..."
          for file in .github/workflows/*.yml; do
            if [ -f "$file" ] && [[ ! "$file" == *.disabled ]]; then
              echo "Checking $file..."
              # Basic YAML syntax check
              python3 -c "import yaml; yaml.safe_load(open('$file'))" && echo "‚úì $file is valid YAML" || echo "‚úó $file has YAML syntax errors"
            fi
          done

  test-coverage:
    name: Analysis - Test Coverage
    runs-on: ubuntu-latest
    needs: [check-trigger, discovery]
    if: needs.check-trigger.outputs.should-run-scan == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage (Free)
        continue-on-error: true
        run: |
          echo "Running tests with coverage..."
          npm test -- --coverage --coverageReporters=json-summary --coverageReporters=text || true
      
      - name: Check test coverage
        continue-on-error: true
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "Test coverage report:"
            cat coverage/coverage-summary.json | jq '.total'
          else
            echo "‚ö† No coverage report generated"
          fi

  aggregate-results:
    name: Aggregate Scan Results
    runs-on: ubuntu-latest
    needs: [check-trigger, discovery, static-analysis, security-scan, dependency-check, configuration-check, test-coverage]
    if: always() && needs.check-trigger.outputs.should-run-scan == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: scan-results
      
      - name: Generate scan summary
        run: |
          echo "# Audit Scan Results - $(date)" > scan-summary.md
          echo "" >> scan-summary.md
          echo "## Discovery Summary" >> scan-summary.md
          echo "Total files scanned: ${{ needs.discovery.outputs.total-files }}" >> scan-summary.md
          echo "" >> scan-summary.md
          
          echo "## Analysis Stages Completed" >> scan-summary.md
          echo "- ‚úì Static Analysis (ESLint, TypeScript)" >> scan-summary.md
          echo "- ‚úì Security Scanning (npm audit, CodeQL)" >> scan-summary.md
          echo "- ‚úì Dependency Health Check" >> scan-summary.md
          echo "- ‚úì Configuration Validation" >> scan-summary.md
          echo "- ‚úì Test Coverage Analysis" >> scan-summary.md
          echo "" >> scan-summary.md
          
          echo "## Next Steps" >> scan-summary.md
          echo "Run 'audit-classify.yml' workflow to classify and prioritize issues." >> scan-summary.md
          
          cat scan-summary.md
      
      - name: Upload scan summary
        uses: actions/upload-artifact@v5
        with:
          name: audit-scan-summary
          path: scan-summary.md
          retention-days: 30
      
      - name: Comment on commit (if push event)
        if: github.event_name == 'push'
        uses: peter-evans/commit-comment@v4
        with:
          body: |
            ## üîç Audit Scan Completed
            
            The comprehensive audit scan has been completed for this commit.
            
            **Files Scanned:** ${{ needs.discovery.outputs.total-files }}
            
            **Analysis Completed:**
            - ‚úì Static Code Analysis
            - ‚úì Security Scanning
            - ‚úì Dependency Health Check
            - ‚úì Configuration Validation
            - ‚úì Test Coverage
            
            View detailed results in the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            Next: Classification workflow will process these results.
