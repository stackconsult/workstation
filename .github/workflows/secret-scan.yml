name: Secret Scanning

# Open-source secret scanning using TruffleHog
# No license required - fully free and open source alternative to Gitleaks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'  # Weekly scan on Sunday at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write  # For uploading SARIF results

jobs:
  trufflehog-scan:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
      
      - name: Run TruffleHog scan
        id: trufflehog
        uses: trufflesecurity/trufflehog@main
        with:
          # Scan the entire git history
          path: ./
          base: ""
          head: ${{ github.ref_name }}
          # Generate SARIF report for GitHub Security tab
          extra_args: --json --only-verified
        continue-on-error: true
      
      - name: Scan summary
        run: |
          echo "## ðŸ” Secret Scan Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "TruffleHog has scanned the repository for exposed secrets." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Coverage:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Git commit history" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Current files" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ 700+ secret patterns" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review any findings in the Actions output above." >> $GITHUB_STEP_SUMMARY

  # GitHub native secret scanning (informational)
  github-secret-scanning-info:
    name: GitHub Secret Scanning Info
    runs-on: ubuntu-latest
    
    steps:
      - name: Information about GitHub's native secret scanning
        run: |
          echo "## ðŸ” GitHub Native Secret Scanning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This repository can also use GitHub's built-in secret scanning:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To Enable:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to repository Settings â†’ Security â†’ Code security and analysis" >> $GITHUB_STEP_SUMMARY
          echo "2. Enable 'Secret scanning'" >> $GITHUB_STEP_SUMMARY
          echo "3. Enable 'Push protection' (prevents secrets from being pushed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Benefits:**" >> $GITHUB_STEP_SUMMARY
          echo "- Free for public repositories" >> $GITHUB_STEP_SUMMARY
          echo "- Automatic scanning on every push" >> $GITHUB_STEP_SUMMARY
          echo "- Partner program for token revocation" >> $GITHUB_STEP_SUMMARY
          echo "- No workflow configuration needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See: https://docs.github.com/en/code-security/secret-scanning" >> $GITHUB_STEP_SUMMARY

  # Optional: Gitleaks with BYOK (only if license is provided)
  gitleaks-scan:
    name: Gitleaks Scan (Optional - BYOK)
    runs-on: ubuntu-latest
    if: vars.ENABLE_GITLEAKS == 'true'  # Only run if explicitly enabled
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Validate Gitleaks License
        id: validate-license
        uses: ./.github/actions/validate-credentials
        with:
          credential-name: 'GITLEAKS_LICENSE'
          credential-value: ${{ secrets.GITLEAKS_LICENSE }}
          filler-patterns: '["PLACEHOLDER", "YOUR_", "FILLER", "EXAMPLE", "TODO", "CHANGEME", "gitleaks"]'
      
      - name: Run Gitleaks scan or skip
        id: gitleaks
        run: |
          set -e
          
          CRED_STATUS="${{ steps.validate-license.outputs.status }}"
          SKIP_REASON="${{ steps.validate-license.outputs.skip-reason }}"
          
          echo "### ðŸ” Gitleaks Scan (Optional BYOK)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CRED_STATUS" = "valid" ]; then
            echo "**Status:** Running with valid license" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Run actual Gitleaks scan
            docker run --rm -v $(pwd):/repo zricethezav/gitleaks:latest detect \
              --source /repo \
              --verbose \
              --report-format sarif \
              --report-path /repo/gitleaks-results.sarif \
              --exit-code 0 || true
            
            if [ -f gitleaks-results.sarif ]; then
              echo "âœ… Gitleaks scan completed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Gitleaks scan completed but no results file generated" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$CRED_STATUS" = "filler" ]; then
            echo "â­ï¸ **Workflow Completed with Filler Credentials**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$SKIP_REASON" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action:** Gitleaks scan skipped (using free TruffleHog instead)" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Completed successfully (no action required)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Free Alternative:** TruffleHog scan runs without license" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Workflow Completed - License Not Configured**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$SKIP_REASON" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action:** Gitleaks scan skipped (license not configured)" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Completed successfully (free TruffleHog scan used instead)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable Gitleaks Pro features:" >> $GITHUB_STEP_SUMMARY
            echo "1. Obtain a Gitleaks license" >> $GITHUB_STEP_SUMMARY
            echo "2. Add GITLEAKS_LICENSE secret to repository" >> $GITHUB_STEP_SUMMARY
            echo "3. Set ENABLE_GITLEAKS variable to 'true'" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
      
      - name: Upload SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

  scan-status:
    name: Scan Status Summary
    runs-on: ubuntu-latest
    needs: [trufflehog-scan, github-secret-scanning-info]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## âœ… Secret Scanning Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Active Scanners:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ TruffleHog (Open Source - No license required)" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸ GitHub Native (Enable in repository settings)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ vars.ENABLE_GITLEAKS }}" == "true" ]; then
            echo "- âœ“ Gitleaks (BYOK - License provided)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŠ˜ Gitleaks (BYOK - Disabled, requires license)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results:** Check the workflow logs and Security tab for findings" >> $GITHUB_STEP_SUMMARY
