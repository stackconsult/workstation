name: Secret Scanning

# Open-source secret scanning using TruffleHog
# No license required - fully free and open source alternative to Gitleaks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'  # Weekly scan on Sunday at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write  # For uploading SARIF results

jobs:
  trufflehog-scan:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
      
      - name: Run TruffleHog scan
        id: trufflehog
        uses: trufflesecurity/trufflehog@main
        with:
          # Scan the entire git history
          path: ./
          base: ""
          head: ${{ github.ref_name }}
          # Generate SARIF report for GitHub Security tab
          extra_args: --json --only-verified
        continue-on-error: true
      
      - name: Scan summary
        run: |
          echo "## ðŸ” Secret Scan Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "TruffleHog has scanned the repository for exposed secrets." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Coverage:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Git commit history" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Current files" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ 700+ secret patterns" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review any findings in the Actions output above." >> $GITHUB_STEP_SUMMARY

  # GitHub native secret scanning (informational)
  github-secret-scanning-info:
    name: GitHub Secret Scanning Info
    runs-on: ubuntu-latest
    
    steps:
      - name: Information about GitHub's native secret scanning
        run: |
          echo "## ðŸ” GitHub Native Secret Scanning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This repository can also use GitHub's built-in secret scanning:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To Enable:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to repository Settings â†’ Security â†’ Code security and analysis" >> $GITHUB_STEP_SUMMARY
          echo "2. Enable 'Secret scanning'" >> $GITHUB_STEP_SUMMARY
          echo "3. Enable 'Push protection' (prevents secrets from being pushed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Benefits:**" >> $GITHUB_STEP_SUMMARY
          echo "- Free for public repositories" >> $GITHUB_STEP_SUMMARY
          echo "- Automatic scanning on every push" >> $GITHUB_STEP_SUMMARY
          echo "- Partner program for token revocation" >> $GITHUB_STEP_SUMMARY
          echo "- No workflow configuration needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See: https://docs.github.com/en/code-security/secret-scanning" >> $GITHUB_STEP_SUMMARY

  # Optional: Gitleaks with BYOK (only if license is provided)
  gitleaks-scan:
    name: Gitleaks Scan (Optional - BYOK)
    runs-on: ubuntu-latest
    if: vars.ENABLE_GITLEAKS == 'true'  # Only run if explicitly enabled
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Run Gitleaks scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true
      
      - name: Upload SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

  scan-status:
    name: Scan Status Summary
    runs-on: ubuntu-latest
    needs: [trufflehog-scan, github-secret-scanning-info]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## âœ… Secret Scanning Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Active Scanners:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ TruffleHog (Open Source - No license required)" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸ GitHub Native (Enable in repository settings)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ vars.ENABLE_GITLEAKS }}" == "true" ]; then
            echo "- âœ“ Gitleaks (BYOK - License provided)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŠ˜ Gitleaks (BYOK - Disabled, requires license)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results:** Check the workflow logs and Security tab for findings" >> $GITHUB_STEP_SUMMARY
