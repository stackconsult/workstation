name: Admin Control Panel

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select Action'
        required: true
        type: choice
        options:
          - Health Check
          - Generate Demo Token
          - View API Documentation
          - Check System Status
      
      # Token generation inputs
      userId:
        description: 'User ID (optional - for custom token)'
        required: false
        type: string
      
      userRole:
        description: 'User Role (optional - for custom token)'
        required: false
        type: choice
        options:
          - user
          - admin
        default: user

jobs:
  execute-action:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate credentials
        id: validate-creds
        uses: ./.github/actions/validate-credentials
        with:
          credential-name: 'RAILWAY_URL'
          credential-value: ${{ secrets.RAILWAY_URL }}
          filler-patterns: '["PLACEHOLDER", "YOUR_", "FILLER", "EXAMPLE", "TODO", "CHANGEME", "https://your-app", "https://example"]'
      
      - name: Setup info
        run: |
          echo "ðŸŽ¯ Executing: ${{ github.event.inputs.action }}"
          echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "â° Time: $(date)"
          echo "ðŸ” Credential Status: ${{ steps.validate-creds.outputs.status }}"
      
      - name: Skip or Execute Health Check
        if: github.event.inputs.action == 'Health Check'
        run: |
          set -e
          
          echo "### ðŸ¥ Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CRED_STATUS="${{ steps.validate-creds.outputs.status }}"
          SKIP_REASON="${{ steps.validate-creds.outputs.skip-reason }}"
          
          if [ "$CRED_STATUS" = "valid" ]; then
            # Real credentials - execute health check
            echo "Checking health at ${{ secrets.RAILWAY_URL }}/health"
            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" ${{ secrets.RAILWAY_URL }}/health || echo "ERROR: Connection failed")
            
            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)
            BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")
            
            echo "**Status Code:** $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$BODY" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Application is healthy!" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Health check failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          elif [ "$CRED_STATUS" = "filler" ]; then
            # Filler credentials - complete gracefully
            echo "â­ï¸ **Workflow Completed with Filler Credentials**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$SKIP_REASON" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action:** Health check skipped (no real deployment URL configured)" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Completed successfully (no action required)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To use this feature with real credentials:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to repository Settings > Secrets and variables > Actions" >> $GITHUB_STEP_SUMMARY
            echo "2. Update secret: RAILWAY_URL" >> $GITHUB_STEP_SUMMARY
            echo "3. Value: Your actual Railway deployment URL" >> $GITHUB_STEP_SUMMARY
          else
            # Missing credentials - complete gracefully
            echo "â­ï¸ **Workflow Completed - Credentials Not Configured**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$SKIP_REASON" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Completed successfully (configuration required)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To use this feature:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to repository Settings > Secrets and variables > Actions" >> $GITHUB_STEP_SUMMARY
            echo "2. Add new secret: RAILWAY_URL" >> $GITHUB_STEP_SUMMARY
            echo "3. Value: Your Railway deployment URL (e.g., https://your-app.railway.app)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Generate Demo Token
        if: github.event.inputs.action == 'Generate Demo Token'
        run: |
          echo "### ðŸ”‘ Demo Token Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ secrets.RAILWAY_URL }}" ]; then
            echo "Generating demo token..."
            RESPONSE=$(curl -s ${{ secrets.RAILWAY_URL }}/auth/demo-token)
            
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$RESPONSE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Token generated successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Usage:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo 'curl -H "Authorization: Bearer YOUR_TOKEN" ${{ secrets.RAILWAY_URL }}/api/protected' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ RAILWAY_URL secret not configured" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Generate Custom Token
        if: github.event.inputs.userId != ''
        run: |
          echo "### ðŸ” Custom Token Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**User ID:** ${{ github.event.inputs.userId }}" >> $GITHUB_STEP_SUMMARY
          echo "**Role:** ${{ github.event.inputs.userRole }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ secrets.RAILWAY_URL }}" ]; then
            RESPONSE=$(curl -s -X POST ${{ secrets.RAILWAY_URL }}/auth/token \
              -H "Content-Type: application/json" \
              -d "{\"userId\":\"${{ github.event.inputs.userId }}\",\"role\":\"${{ github.event.inputs.userRole }}\"}")
            
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$RESPONSE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Custom token generated!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ RAILWAY_URL secret not configured" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: View API Documentation
        if: github.event.inputs.action == 'View API Documentation'
        run: |
          echo "### ðŸ“š API Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Available Documentation:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ“– [API Reference](https://github.com/${{ github.repository }}/blob/main/API.md)" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ—ï¸ [Architecture](https://github.com/${{ github.repository }}/blob/main/ARCHITECTURE.md)" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ–¼ï¸ [Interface Solutions](https://github.com/${{ github.repository }}/blob/main/INTERFACE_SOLUTIONS.md)" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸš€ [Deployment Guide](https://github.com/${{ github.repository }}/blob/main/DEPLOYMENT.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ secrets.RAILWAY_URL }}" ]; then
            echo "**Live API Endpoints:**" >> $GITHUB_STEP_SUMMARY
            echo "- Health: ${{ secrets.RAILWAY_URL }}/health" >> $GITHUB_STEP_SUMMARY
            echo "- Demo Token: ${{ secrets.RAILWAY_URL }}/auth/demo-token" >> $GITHUB_STEP_SUMMARY
            echo "- API Docs (if enabled): ${{ secrets.RAILWAY_URL }}/api-docs" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check System Status
        if: github.event.inputs.action == 'Check System Status'
        run: |
          echo "### ðŸ“Š System Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Repository info
          echo "**Repository:**" >> $GITHUB_STEP_SUMMARY
          echo "- Name: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Last commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Deployment status
          if [ -n "${{ secrets.RAILWAY_URL }}" ]; then
            echo "**Deployment:**" >> $GITHUB_STEP_SUMMARY
            echo "- Railway URL: ${{ secrets.RAILWAY_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Checking..." >> $GITHUB_STEP_SUMMARY
            
            if curl -s --connect-timeout 5 ${{ secrets.RAILWAY_URL }}/health > /dev/null; then
              echo "- Health: âœ… Online" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Health: âŒ Offline or unreachable" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Deployment:**" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Not configured (RAILWAY_URL secret missing)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Info:**" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
      
      - name: Final Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Tips" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- To use this control panel effectively, add your RAILWAY_URL as a repository secret" >> $GITHUB_STEP_SUMMARY
          echo "- Generate custom tokens by providing a User ID in the workflow inputs" >> $GITHUB_STEP_SUMMARY
          echo "- For UI options, see [INTERFACE_SOLUTIONS.md](https://github.com/${{ github.repository }}/blob/main/INTERFACE_SOLUTIONS.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run completed at:** $(date)" >> $GITHUB_STEP_SUMMARY
