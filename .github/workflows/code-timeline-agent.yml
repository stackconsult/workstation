name: Code Timeline Agent - Daily Code Growth Tracking

on:
  schedule:
    # Runs at 7:00 AM UTC daily
    - cron: '0 7 * * *'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      dry_run:
        description: 'Dry run (preview changes without committing)'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: read

jobs:
  update-timeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for timeline
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Calculate code statistics
        id: stats
        run: |
          # Production code
          PROD_LOC=$(find src -name '*.ts' -o -name '*.js' 2>/dev/null | xargs cat 2>/dev/null | wc -l)
          echo "prod_loc=$PROD_LOC" >> $GITHUB_OUTPUT
          
          # Chrome extension
          CHROME_LOC=$(find chrome-extension -name '*.js' 2>/dev/null | xargs cat 2>/dev/null | wc -l)
          echo "chrome_loc=$CHROME_LOC" >> $GITHUB_OUTPUT
          
          # Tests
          TEST_LOC=$(find tests -name '*.ts' 2>/dev/null | xargs cat 2>/dev/null | wc -l)
          echo "test_loc=$TEST_LOC" >> $GITHUB_OUTPUT
          
          # Total
          TOTAL_LOC=$((PROD_LOC + CHROME_LOC + TEST_LOC))
          echo "total_loc=$TOTAL_LOC" >> $GITHUB_OUTPUT
          
          # File counts
          echo "total_files=$(git ls-files | wc -l)" >> $GITHUB_OUTPUT
          echo "ts_files=$(find src -name '*.ts' 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "test_files=$(find tests -name '*.test.ts' -o -name '*.spec.ts' 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          
          # Automations and agents
          echo "workflows=$(ls -1 .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "agents=$(ls -d agents/*/ 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
      
      - name: Get repository age
        id: age
        run: |
          FIRST_COMMIT=$(git log --reverse --format='%at' | head -1)
          CURRENT=$(date +%s)
          AGE_DAYS=$(( (CURRENT - FIRST_COMMIT) / 86400 ))
          echo "age_days=$AGE_DAYS" >> $GITHUB_OUTPUT
          
          AVG_DAILY=$(echo "scale=1; ${{ steps.stats.outputs.total_loc }} / $AGE_DAYS" | bc)
          echo "avg_daily=$AVG_DAILY" >> $GITHUB_OUTPUT
      
      - name: Update CODE_TIMELINE.md
        run: |
          CURRENT_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
          # Calculate next update date (tomorrow at 07:00 UTC)
          TOMORROW=$(date -u -d "+1 day" +%Y-%m-%d 2>/dev/null || date -u -v+1d +%Y-%m-%d)
          NEXT_UPDATE="${TOMORROW} 07:00 UTC"
          
          # Update the timeline (this is a simplified version - full implementation would be more complex)
          cat > CODE_TIMELINE_TEMP.md <<- 'EOFTIMELINE'
          # ðŸ“Š Repository Code Timeline & Growth Tracker

          **Last Updated**: CURRENT_DATE_PLACEHOLDER  
          **Next Update**: NEXT_UPDATE_PLACEHOLDER  
          **Tracking Agent**: Code Timeline Agent v1.0.0

          ---

          ## ðŸ“ˆ Code Growth Timeline

          ### Current Statistics

          **Total Lines of Code**: ${{ steps.stats.outputs.total_loc }}

          - Production Code (src/): ${{ steps.stats.outputs.prod_loc }} LOC
          - Chrome Extension: ${{ steps.stats.outputs.chrome_loc }} LOC
          - Test Code (tests/): ${{ steps.stats.outputs.test_loc }} LOC

          **Repository Metrics**:
          - Total Files: ${{ steps.stats.outputs.total_files }}
          - TypeScript Files: ${{ steps.stats.outputs.ts_files }}
          - Test Files: ${{ steps.stats.outputs.test_files }}
          - GitHub Workflows: ${{ steps.stats.outputs.workflows }}
          - Agents: ${{ steps.stats.outputs.agents }}

          **Repository Age**: ${{ steps.age.outputs.age_days }} days  
          **Average Daily Growth**: ${{ steps.age.outputs.avg_daily }} LOC/day

          ---

          ## ðŸ“Š Current Code Composition

          \`\`\`
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  CODE DISTRIBUTION (as of CURRENT_DATE_PLACEHOLDER)         â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                             â”‚
          â”‚  Production Code (src/)          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  ${{ steps.stats.outputs.prod_loc }} LOC â”‚
          â”‚  Chrome Extension                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  ${{ steps.stats.outputs.chrome_loc }} LOC â”‚
          â”‚  Test Code (tests/)              â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  ${{ steps.stats.outputs.test_loc }} LOC â”‚
          â”‚                                                             â”‚
          â”‚  Total Application Code:                        ${{ steps.stats.outputs.total_loc }} LOC â”‚
          â”‚                                                             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          \`\`\`

          ---

          ## ðŸ”„ Update Schedule

          **Agent**: Code Timeline Agent  
          **Frequency**: Daily at 7:00 AM UTC  
          **Next Update**: $NEXT_UPDATE

          ---

          **Managed by**: Code Timeline Agent v1.0.0  
          **Last Updated**: CURRENT_DATE_PLACEHOLDER  
          **Next Update**: NEXT_UPDATE_PLACEHOLDER
          EOFTIMELINE
          
          # Replace placeholders with actual values
          sed -i "s/CURRENT_DATE_PLACEHOLDER/$CURRENT_DATE/g" CODE_TIMELINE_TEMP.md
          sed -i "s/NEXT_UPDATE_PLACEHOLDER/$NEXT_UPDATE/g" CODE_TIMELINE_TEMP.md
          
          # Replace file (keeping the full template from the original)
          if [ -f CODE_TIMELINE.md ]; then
            mv CODE_TIMELINE_TEMP.md CODE_TIMELINE.md
            echo "Timeline updated successfully"
          else
            mv CODE_TIMELINE_TEMP.md CODE_TIMELINE.md
            echo "Timeline created successfully"
          fi
      
      - name: Update AUTOMATION_DIRECTORY.md
        run: |
          # Count automation runs (this would need to be tracked in a database)
          # For now, just update the timestamp
          CURRENT_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
          TOMORROW=$(date -u -d "+1 day" +%Y-%m-%d 2>/dev/null || date -u -v+1d +%Y-%m-%d)
          NEXT_UPDATE="${TOMORROW} 07:00 UTC"
          
          if [ -f AUTOMATION_DIRECTORY.md ]; then
            sed -i "s/Last Updated\*\*: .*/Last Updated**: ${CURRENT_DATE}/" AUTOMATION_DIRECTORY.md || true
            sed -i "s/Next Update\*\*: .*/Next Update**: ${NEXT_UPDATE}/" AUTOMATION_DIRECTORY.md || true
            echo "AUTOMATION_DIRECTORY.md updated"
          else
            echo "AUTOMATION_DIRECTORY.md not found, skipping update"
          fi
      
      - name: Commit changes
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "Code Timeline Agent"
          git config user.email "code-timeline-agent@workstation.github.io"
          
          git add CODE_TIMELINE.md AUTOMATION_DIRECTORY.md || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "ðŸ“Š Daily code timeline update - $(date -u +'%Y-%m-%d %H:%M UTC')

          - Total LOC: ${{ steps.stats.outputs.total_loc }}
          - Production: ${{ steps.stats.outputs.prod_loc }}
          - Chrome Extension: ${{ steps.stats.outputs.chrome_loc }}
          - Tests: ${{ steps.stats.outputs.test_loc }}
          - Repository age: ${{ steps.age.outputs.age_days }} days
          - Avg daily growth: ${{ steps.age.outputs.avg_daily }} LOC/day
          
          Automated by Code Timeline Agent v1.0.0"
          
          git push
      
      - name: Dry run output
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "=== DRY RUN MODE ==="
          echo "Statistics:"
          echo "  Total LOC: ${{ steps.stats.outputs.total_loc }}"
          echo "  Production: ${{ steps.stats.outputs.prod_loc }}"
          echo "  Chrome Extension: ${{ steps.stats.outputs.chrome_loc }}"
          echo "  Tests: ${{ steps.stats.outputs.test_loc }}"
          echo "  Repository age: ${{ steps.age.outputs.age_days }} days"
          echo "  Avg daily growth: ${{ steps.age.outputs.avg_daily }} LOC/day"
