name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Install Playwright Browsers (Full)
        if: matrix.node-version == '20.x'
        run: npx playwright install --with-deps
      
      - name: Generate dependency map
        run: |
          npm install -g madge
          madge --image dependency-graph.svg --extensions ts,js src
        continue-on-error: true
      
      - name: Upload dependency graph
        if: matrix.node-version == '20.x'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-graph
          path: dependency-graph.svg
        continue-on-error: true
      
      - name: Generate documentation
        run: |
          npm install -g typedoc
          npx typedoc --out docs-generated src
        continue-on-error: true
      
      - name: Upload generated documentation
        if: matrix.node-version == '20.x'
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs-generated
        continue-on-error: true
      
      - name: Run linter
        run: npm run lint
      
      - name: Build project
        run: npm run build
      
      - name: Run tests with coverage
        run: npm test -- --coverage
        env:
          JWT_SECRET: test-secret-for-ci
          NODE_ENV: test
      
      - name: Check coverage scaling
        run: node scripts/coverage-scaling.js check
        continue-on-error: false
      
      - name: Upload coverage reports
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for secret scanning
      
      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run TruffleHog secret scan
        uses: trufflesecurity/trufflehog@v3.91.0
        with:
          path: ./
          base: ""
          head: ${{ github.ref_name }}
          extra_args: --json --only-verified
        continue-on-error: true
      
      - name: Secret detection with Gitleaks (optional)
        run: |
          if [ -z "${{ secrets.GITLEAKS_LICENSE }}" ]; then
            echo "GITLEAKS_LICENSE not set â€” skipping Gitleaks (optional).";
            echo "To enable Gitleaks, add GITLEAKS_LICENSE to repository secrets.";
            exit 0;
          else
            echo "GITLEAKS_LICENSE present â€” running Gitleaks action.";
          fi
        shell: bash
      - name: Validate Gitleaks License
        id: validate-gitleaks
        uses: ./.github/actions/validate-credentials
        with:
          credential-name: 'GITLEAKS_LICENSE'
          credential-value: ${{ secrets.GITLEAKS_LICENSE }}
          filler-patterns: '["PLACEHOLDER", "YOUR_", "FILLER", "EXAMPLE", "TODO", "CHANGEME", "gitleaks"]'
      
      - name: Secret detection with Gitleaks or skip
        run: |
          set -e
          
          CRED_STATUS="${{ steps.validate-gitleaks.outputs.status }}"
          SKIP_REASON="${{ steps.validate-gitleaks.outputs.skip-reason }}"
          
          echo "### ðŸ” Gitleaks Secret Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CRED_STATUS" = "valid" ]; then
            echo "**Status:** Running with valid license" >> $GITHUB_STEP_SUMMARY
            
            # Run actual Gitleaks scan
            docker run --rm -v $(pwd):/repo zricethezav/gitleaks:latest detect \
              --source /repo \
              --verbose \
              --exit-code 0 || true
            
            echo "âœ… Gitleaks scan completed" >> $GITHUB_STEP_SUMMARY
          elif [ "$CRED_STATUS" = "filler" ]; then
            echo "â­ï¸ **Gitleaks scan skipped (filler credentials)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$SKIP_REASON" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Alternative:** TruffleHog scan ran above (no license required)" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Gitleaks scan skipped (license not configured)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Alternative:** TruffleHog scan ran above (no license required)" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Completed successfully" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
      
      - name: Run npm audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate || echo "npm audit found issues but continuing..."
        continue-on-error: true
      
      - name: Check for known vulnerabilities with audit-ci
        run: |
          echo "Running audit-ci..."
          npm run audit-ci || echo "audit-ci found issues but continuing..."
        continue-on-error: true

  build-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            # Git SHA for exact version tracking
            type=sha,prefix={{branch}}-,format=short
            type=sha,format=long
            # Branch name tag
            type=ref,event=branch
            # Latest tag for main branch
            type=raw,value=latest,enable={{is_default_branch}}
            # Semantic versioning (when tags are pushed)
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
          labels: |
            org.opencontainers.image.title=stackBrowserAgent
            org.opencontainers.image.description=Lightweight JWT-based authentication service
            org.opencontainers.image.vendor=creditXcredit
      
      - name: Build and push Docker image
        id: docker_build
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ghcr.io/${{ github.repository }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,secret,config'
          exit-code: '0'  # Don't fail on vulnerabilities, just report
        env:
          TRIVY_USERNAME: ${{ github.actor }}
          TRIVY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'docker-image-scan'
        continue-on-error: true
      
      - name: Check for critical vulnerabilities
        run: |
          # Scan the image again for detailed output
          docker pull ghcr.io/${{ github.repository }}:${{ github.sha }}
          
          # Install Trivy if not available
          if ! command -v trivy &> /dev/null; then
            wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
            echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
            sudo apt-get update
            sudo apt-get install trivy -y
          fi
          
          # Determine if this is an update or new install
          IS_UPDATE="false"
          if docker manifest inspect ghcr.io/${{ github.repository }}:latest > /dev/null 2>&1; then
            IS_UPDATE="true"
            echo "âœ“ Detected UPDATE scenario - existing image found"
          else
            echo "âœ“ Detected NEW INSTALL scenario - no previous image"
          fi
          
          echo "IS_UPDATE=$IS_UPDATE" >> $GITHUB_ENV
          
          # Run vulnerability scan
          echo "### ðŸ” Docker Image Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Type:** $([ "$IS_UPDATE" = "true" ] && echo "Update" || echo "New Install")" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ghcr.io/${{ github.repository }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run scan and capture results
          trivy image --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output trivy-scan.json \
            ghcr.io/${{ github.repository }}:${{ github.sha }} || true
          
          # Parse results
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-scan.json || echo "0")
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-scan.json || echo "0")
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-scan.json || echo "0")
          
          echo "**Vulnerabilities Found:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”´ Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ  High: $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ¡ Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # For updates, enforce stricter scanning (don't pass with vulnerabilities)
          if [ "$IS_UPDATE" = "true" ]; then
            if [ "$CRITICAL" -gt 0 ]; then
              echo "âŒ **SCAN FAILED:** Critical vulnerabilities found in UPDATE" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "For updates, critical vulnerabilities must be resolved before deployment." >> $GITHUB_STEP_SUMMARY
              echo "Review the Security tab for details." >> $GITHUB_STEP_SUMMARY
              exit 1
            elif [ "$HIGH" -gt 5 ]; then
              echo "âš ï¸ **WARNING:** More than 5 high-severity vulnerabilities found in UPDATE" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Consider addressing these vulnerabilities before production deployment." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **SCAN PASSED:** No critical vulnerabilities in UPDATE" >> $GITHUB_STEP_SUMMARY
            fi
          else
            # For new installs, be more lenient but still report
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 10 ]; then
              echo "âš ï¸ **WARNING:** Vulnerabilities detected in NEW INSTALL" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Review and address vulnerabilities before production use." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **SCAN PASSED:** Acceptable vulnerability level for NEW INSTALL" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in the [Security](/${{ github.repository }}/security/code-scanning) tab." >> $GITHUB_STEP_SUMMARY
      
      - name: Generate image summary
        run: |
          echo "### Docker Image Published :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ghcr.io/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull commands:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Pull latest version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Pull this specific commit" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback instructions:** See ROLLBACK_GUIDE.md" >> $GITHUB_STEP_SUMMARY

  report-failures:
    name: Report CI Failures
    runs-on: ubuntu-latest
    needs: [test, security]
    if: failure()
    permissions:
      issues: write
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[CI Failure] Automated build/test failure on ${context.ref}`;
            const body = `## CI Pipeline Failure Report
            
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}
            **Triggered by:** ${context.actor}
            **Event:** ${context.eventName}
            
            ### Failure Details
            One or more CI jobs failed. Please review the workflow run for details:
            
            [View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### Action Items
            - [ ] Review failed job logs
            - [ ] Fix any test failures
            - [ ] Address any security vulnerabilities
            - [ ] Ensure coverage requirements are met (>=55%)
            - [ ] Verify Playwright browsers install correctly
            - [ ] Check for secret leaks
            
            ### Labels Applied
            - \`automation-fail\` - Indicates automated CI failure
            - \`blocking\` - Blocks merges until resolved
            
            This issue was automatically created by the CI/CD pipeline.
            `;
            
            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automation-fail',
              per_page: 10
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(context.ref) && 
              issue.created_at > new Date(Date.now() - 86400000).toISOString()
            );
            
            if (existingIssue) {
              // Update existing issue with comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### Additional Failure\n\nAnother CI failure occurred for this branch.\n\n[View Latest Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n**Commit:** ${context.sha}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automation-fail', 'blocking']
              });
              console.log(`Created issue #${issue.data.number}`);
            }

