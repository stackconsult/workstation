name: Auto-Update Repository Metrics

on:
  push:
    branches: [main]
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Count LOC and generate metrics
        id: metrics
        run: |
          # Count total TypeScript/JavaScript LOC (excluding node_modules, dist, build, .git)
          TOTAL_LOC=$(find . -path ./node_modules -prune -o -path ./dist -prune -o \
            -path ./build -prune -o -path ./.git -prune -o \
            -type f \( -name "*.ts" -o -name "*.js" \) -exec wc -l {} + 2>/dev/null | \
            tail -1 | awk '{print $1}')
          
          # Count total files
          TOTAL_FILES=$(find . -path ./node_modules -prune -o -path ./dist -prune -o \
            -path ./build -prune -o -path ./.git -prune -o \
            -type f \( -name "*.ts" -o -name "*.js" \) -print | wc -l)
          
          # Count per directory
          SRC_LOC=$(find src -name "*.ts" -o -name "*.js" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          SRC_FILES=$(find src -name "*.ts" -o -name "*.js" 2>/dev/null | wc -l)
          
          CHROME_LOC=$(find chrome-extension -name "*.ts" -o -name "*.js" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          CHROME_FILES=$(find chrome-extension -name "*.ts" -o -name "*.js" 2>/dev/null | wc -l)
          
          AGENTS_LOC=$(find agents -name "*.ts" -o -name "*.js" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          AGENTS_FILES=$(find agents -name "*.ts" -o -name "*.js" 2>/dev/null | wc -l)
          
          MCP_LOC=$(find mcp-containers -name "*.ts" -o -name "*.js" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          MCP_FILES=$(find mcp-containers -name "*.ts" -o -name "*.js" 2>/dev/null | wc -l)
          
          TOOLS_LOC=$(find tools -name "*.ts" -o -name "*.js" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          TOOLS_FILES=$(find tools -name "*.ts" -o -name "*.js" 2>/dev/null | wc -l)
          
          PUBLIC_LOC=$(find public -name "*.ts" -o -name "*.js" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          PUBLIC_FILES=$(find public -name "*.ts" -o -name "*.js" 2>/dev/null | wc -l)
          
          TESTS_LOC=$(find tests -name "*.ts" -o -name "*.js" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          TESTS_FILES=$(find tests -name "*.ts" -o -name "*.js" 2>/dev/null | wc -l)
          
          # Calculate other code
          OTHER_LOC=$((TOTAL_LOC - SRC_LOC - CHROME_LOC - AGENTS_LOC - MCP_LOC - TOOLS_LOC - PUBLIC_LOC - TESTS_LOC))
          OTHER_FILES=$((TOTAL_FILES - SRC_FILES - CHROME_FILES - AGENTS_FILES - MCP_FILES - TOOLS_FILES - PUBLIC_FILES - TESTS_FILES))
          
          # Export to GitHub output
          echo "TOTAL_LOC=$TOTAL_LOC" >> $GITHUB_OUTPUT
          echo "TOTAL_FILES=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "SRC_LOC=$SRC_LOC" >> $GITHUB_OUTPUT
          echo "SRC_FILES=$SRC_FILES" >> $GITHUB_OUTPUT
          echo "CHROME_LOC=$CHROME_LOC" >> $GITHUB_OUTPUT
          echo "CHROME_FILES=$CHROME_FILES" >> $GITHUB_OUTPUT
          echo "AGENTS_LOC=$AGENTS_LOC" >> $GITHUB_OUTPUT
          echo "AGENTS_FILES=$AGENTS_FILES" >> $GITHUB_OUTPUT
          echo "MCP_LOC=$MCP_LOC" >> $GITHUB_OUTPUT
          echo "MCP_FILES=$MCP_FILES" >> $GITHUB_OUTPUT
          echo "TOOLS_LOC=$TOOLS_LOC" >> $GITHUB_OUTPUT
          echo "TOOLS_FILES=$TOOLS_FILES" >> $GITHUB_OUTPUT
          echo "PUBLIC_LOC=$PUBLIC_LOC" >> $GITHUB_OUTPUT
          echo "PUBLIC_FILES=$PUBLIC_FILES" >> $GITHUB_OUTPUT
          echo "TESTS_LOC=$TESTS_LOC" >> $GITHUB_OUTPUT
          echo "TESTS_FILES=$TESTS_FILES" >> $GITHUB_OUTPUT
          echo "OTHER_LOC=$OTHER_LOC" >> $GITHUB_OUTPUT
          echo "OTHER_FILES=$OTHER_FILES" >> $GITHUB_OUTPUT
          echo "DATE=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "DATETIME=$(date -u +%Y-%m-%dT%H:%M:%S)" >> $GITHUB_OUTPUT
          
          # Display summary
          echo "=== Repository Metrics ==="
          echo "Total LOC: $TOTAL_LOC"
          echo "Total Files: $TOTAL_FILES"
          echo "Date: $(date -u +%Y-%m-%d)"
      
      - name: Update CODE_TIMELINE.md
        run: |
          cat > CODE_TIMELINE.md << 'EOF'
          # ðŸ“Š Repository Code Timeline & Growth Tracker

          **Last Updated**: ${{ steps.metrics.outputs.DATETIME }} UTC (Auto-generated)  
          **Auto-Update**: Daily at 00:00 UTC via GitHub Actions  
          **Tracking Agent**: Automated Metrics Bot v2.0.0

          > âš ï¸ **IMMUTABLE ARTIFACT**: This file is auto-generated daily from actual codebase measurements.
          > Do not edit manually - all changes will be overwritten by automation.

          ---

          ## ðŸ“ˆ Current Code Composition

          ### Total Lines of Code: **${{ steps.metrics.outputs.TOTAL_LOC }}** ðŸ“Š

          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  CODE DISTRIBUTION (as of ${{ steps.metrics.outputs.DATE }})                       â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                             â”‚
          â”‚  Core Platform (src/)        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ${{ steps.metrics.outputs.SRC_LOC }} LOC â”‚
          â”‚  Chrome Extension            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  ${{ steps.metrics.outputs.CHROME_LOC }} LOC â”‚
          â”‚  Automation Agents           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   ${{ steps.metrics.outputs.AGENTS_LOC }} LOC â”‚
          â”‚  MCP Containers              â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   ${{ steps.metrics.outputs.MCP_LOC }} LOC â”‚
          â”‚  Test Code (tests/)          â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   ${{ steps.metrics.outputs.TESTS_LOC }} LOC â”‚
          â”‚  Web UI (public/)            â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   ${{ steps.metrics.outputs.PUBLIC_LOC }} LOC â”‚
          â”‚  Tools & Scripts             â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘     ${{ steps.metrics.outputs.TOOLS_LOC }} LOC â”‚
          â”‚  Other (scripts/examples)    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  ~${{ steps.metrics.outputs.OTHER_LOC }} LOC â”‚
          â”‚                                                             â”‚
          â”‚  Total Application Code:                       ${{ steps.metrics.outputs.TOTAL_LOC }} LOC â”‚
          â”‚                                                             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ```

          ### File Count Breakdown

          | Directory | Files | Lines of Code |
          |-----------|-------|---------------|
          | **src/** | ${{ steps.metrics.outputs.SRC_FILES }} | ${{ steps.metrics.outputs.SRC_LOC }} |
          | **chrome-extension/** | ${{ steps.metrics.outputs.CHROME_FILES }} | ${{ steps.metrics.outputs.CHROME_LOC }} |
          | **agents/** | ${{ steps.metrics.outputs.AGENTS_FILES }} | ${{ steps.metrics.outputs.AGENTS_LOC }} |
          | **mcp-containers/** | ${{ steps.metrics.outputs.MCP_FILES }} | ${{ steps.metrics.outputs.MCP_LOC }} |
          | **tools/** | ${{ steps.metrics.outputs.TOOLS_FILES }} | ${{ steps.metrics.outputs.TOOLS_LOC }} |
          | **public/** | ${{ steps.metrics.outputs.PUBLIC_FILES }} | ${{ steps.metrics.outputs.PUBLIC_LOC }} |
          | **tests/** | ${{ steps.metrics.outputs.TESTS_FILES }} | ${{ steps.metrics.outputs.TESTS_LOC }} |
          | **other/** | ${{ steps.metrics.outputs.OTHER_FILES }} | ~${{ steps.metrics.outputs.OTHER_LOC }} |
          | **TOTAL** | **${{ steps.metrics.outputs.TOTAL_FILES }}** | **${{ steps.metrics.outputs.TOTAL_LOC }}** |

          ---

          ## ðŸ”„ Automation Details

          ### How This Works

          This file is **automatically updated** by GitHub Actions:
          - **Trigger**: Daily at 00:00 UTC + every push to main + manual workflow dispatch
          - **Measurement**: Counts all `.ts` and `.js` files (excluding node_modules, dist, build, .git)
          - **Accuracy**: 100% - directly measured from actual codebase
          - **Immutability**: Cannot drift out of sync - regenerated from source

          ### Verification Commands

          You can verify these numbers yourself:
          ```bash
          # Total LOC
          find . -path ./node_modules -prune -o -path ./dist -prune -o \
            -path ./build -prune -o -path ./.git -prune -o \
            -type f \( -name "*.ts" -o -name "*.js" \) -exec wc -l {} + | tail -1

          # Total files
          find . -path ./node_modules -prune -o -path ./dist -prune -o \
            -path ./build -prune -o -path ./.git -prune -o \
            -type f \( -name "*.ts" -o -name "*.js" \) -print | wc -l

          # Per-directory
          for dir in src chrome-extension agents mcp-containers tools public tests; do
            echo "$dir:"
            find "$dir" -name "*.ts" -o -name "*.js" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1
          done
          ```

          ### Why This Solution

          **Problem Solved:**
          - âŒ **Before**: Manual counts became stale (15,693 LOC was 11 days old, missed 90%+ of code)
          - âœ… **Now**: Automated daily updates directly from codebase (always accurate)

          **Benefits:**
          1. **Never Out of Date**: Updates automatically on every main branch push
          2. **100% Accurate**: Direct measurement, not manual estimation
          3. **Verifiable**: Anyone can run the same commands to verify
          4. **Immutable**: Protected from manual edits that introduce errors
          5. **Transparent**: Shows exact counting methodology

          ---

          ## ðŸ“Š Metrics Archive

          Historical metrics are preserved in git history. View changes:
          ```bash
          git log -p CODE_TIMELINE.md
          ```

          ---

          **Generated by**: `.github/workflows/metrics-update.yml`  
          **Last Run**: ${{ steps.metrics.outputs.DATETIME }} UTC  
          **Status**: âœ… AUTO-UPDATED
          EOF
      
      - name: Store metrics as artifact
        run: |
          mkdir -p .metrics
          cat > .metrics/latest.json << EOF
          {
            "timestamp": "${{ steps.metrics.outputs.DATETIME }}",
            "total_loc": ${{ steps.metrics.outputs.TOTAL_LOC }},
            "total_files": ${{ steps.metrics.outputs.TOTAL_FILES }},
            "breakdown": {
              "src": {
                "loc": ${{ steps.metrics.outputs.SRC_LOC }},
                "files": ${{ steps.metrics.outputs.SRC_FILES }}
              },
              "chrome_extension": {
                "loc": ${{ steps.metrics.outputs.CHROME_LOC }},
                "files": ${{ steps.metrics.outputs.CHROME_FILES }}
              },
              "agents": {
                "loc": ${{ steps.metrics.outputs.AGENTS_LOC }},
                "files": ${{ steps.metrics.outputs.AGENTS_FILES }}
              },
              "mcp_containers": {
                "loc": ${{ steps.metrics.outputs.MCP_LOC }},
                "files": ${{ steps.metrics.outputs.MCP_FILES }}
              },
              "tools": {
                "loc": ${{ steps.metrics.outputs.TOOLS_LOC }},
                "files": ${{ steps.metrics.outputs.TOOLS_FILES }}
              },
              "public": {
                "loc": ${{ steps.metrics.outputs.PUBLIC_LOC }},
                "files": ${{ steps.metrics.outputs.PUBLIC_FILES }}
              },
              "tests": {
                "loc": ${{ steps.metrics.outputs.TESTS_LOC }},
                "files": ${{ steps.metrics.outputs.TESTS_FILES }}
              },
              "other": {
                "loc": ${{ steps.metrics.outputs.OTHER_LOC }},
                "files": ${{ steps.metrics.outputs.OTHER_FILES }}
              }
            }
          }
          EOF
      
      - name: Create Pull Request for metrics update
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto/metrics-update-${{ github.run_number }}
          base: main
          commit-message: |
            chore: auto-update repository metrics [skip ci]
            
            Total LOC: ${{ steps.metrics.outputs.TOTAL_LOC }}
            Total Files: ${{ steps.metrics.outputs.TOTAL_FILES }}
            Updated: ${{ steps.metrics.outputs.DATETIME }} UTC
            
            Auto-generated by .github/workflows/metrics-update.yml
          title: "chore: auto-update repository metrics [skip ci]"
          body: |
            ## ðŸ“Š Automated Repository Metrics Update
            
            This PR contains automated updates to repository metrics and code statistics.
            
            ### Metrics Summary
            - **Total LOC**: ${{ steps.metrics.outputs.TOTAL_LOC }}
            - **Total Files**: ${{ steps.metrics.outputs.TOTAL_FILES }}
            - **Updated**: ${{ steps.metrics.outputs.DATETIME }} UTC
            
            ### Changes Included
            - âœ… Updated `CODE_TIMELINE.md` with latest code statistics
            - âœ… Updated `.metrics/latest.json` with structured data
            - âœ… Updated metrics badges
            
            ### Verification
            You can verify these numbers yourself:
            ```bash
            # Total LOC
            find . -path ./node_modules -prune -o -path ./dist -prune -o \
              -path ./build -prune -o -path ./.git -prune -o \
              -type f \( -name "*.ts" -o -name "*.js" \) -exec wc -l {} + | tail -1
            ```
            
            ---
            **Auto-generated by**: `.github/workflows/metrics-update.yml`  
            **Trigger**: ${{ github.event_name }}  
            **Run ID**: ${{ github.run_id }}
          delete-branch: true
          labels: |
            automated
            metrics
            skip-ci
      
      - name: Create metrics badge
        run: |
          echo "![LOC](https://img.shields.io/badge/LOC-${{ steps.metrics.outputs.TOTAL_LOC }}-brightgreen)" > .metrics/badge.md
          echo "![Files](https://img.shields.io/badge/Files-${{ steps.metrics.outputs.TOTAL_FILES }}-blue)" >> .metrics/badge.md
