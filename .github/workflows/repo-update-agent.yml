name: Repo Update Agent - Daily Documentation Sync

on:
  schedule:
    # Runs at 9:00 PM UTC daily (21:00)
    - cron: '0 21 * * *'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      dry_run:
        description: 'Dry run (preview changes without committing)'
        required: false
        default: 'false'
      targets:
        description: 'Specific files to update (comma-separated, or "all")'
        required: false
        default: 'all'

permissions:
  contents: write
  pull-requests: read
  issues: read

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for accurate stats
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Get repository statistics
        id: stats
        run: |
          echo "total_files=$(git ls-files | wc -l)" >> $GITHUB_OUTPUT
          echo "ts_files=$(find src -name '*.ts' 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "test_files=$(find tests -name '*.test.ts' -o -name '*.spec.ts' 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "doc_files=$(find . -name '*.md' -not -path './node_modules/*' 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "chrome_js=$(find chrome-extension -name '*.js' 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "production_loc=$(find src -name '*.ts' -o -name '*.js' 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "chrome_loc=$(find chrome-extension -name '*.js' 2>/dev/null | xargs cat | wc -l 2>/dev/null)" >> $GITHUB_OUTPUT
          echo "test_loc=$(find tests -name '*.ts' 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "agents=$(ls -d agents/*/ 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "containers=$(ls -d mcp-containers/*/ 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "workflows=$(ls -1 .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
      
      - name: Get recent commits (last 24 hours)
        id: commits
        run: |
          # Calculate 24 hours ago timestamp
          SINCE_TIME=$(date -u -d "24 hours ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-24H +%Y-%m-%dT%H:%M:%SZ)
          COMMIT_COUNT=$(git log --since="$SINCE_TIME" --oneline | wc -l)
          echo "recent_commits=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          
          # Get commit messages
          git log --since="$SINCE_TIME" --pretty=format:"- %h: %s" > recent_commits.txt || echo "- No recent commits" > recent_commits.txt
      
      - name: Create rollback directory
        run: |
          ROLLBACK_DATE=$(date -u +%Y-%m-%d)
          ROLLBACK_DIR="rollbacks/${ROLLBACK_DATE}"
          mkdir -p "$ROLLBACK_DIR"
          
          # Backup current documentation
          cp README.md "$ROLLBACK_DIR/README.md.bak" 2>/dev/null || echo "README.md not found"
          cp REPOSITORY_STATS.md "$ROLLBACK_DIR/REPOSITORY_STATS.md.bak" 2>/dev/null || echo "REPOSITORY_STATS.md not found"
          cp STATS_OVERVIEW.md "$ROLLBACK_DIR/STATS_OVERVIEW.md.bak" 2>/dev/null || echo "STATS_OVERVIEW.md not found"
          cp BUILD_STATISTICS_AND_IMPACT_ANALYSIS.md "$ROLLBACK_DIR/BUILD_STATISTICS_AND_IMPACT_ANALYSIS.md.bak" 2>/dev/null || echo "BUILD_STATISTICS_AND_IMPACT_ANALYSIS.md not found"
          cp ACTIVITY_TIMELINE.md "$ROLLBACK_DIR/ACTIVITY_TIMELINE.md.bak" 2>/dev/null || echo "ACTIVITY_TIMELINE.md not found"
          cp ROADMAP_PROGRESS.md "$ROLLBACK_DIR/ROADMAP_PROGRESS.md.bak" 2>/dev/null || echo "ROADMAP_PROGRESS.md not found"
          
          echo "Rollback created in $ROLLBACK_DIR"
      
      - name: Update REPO_UPDATE_TASKS.md
        run: |
          CURRENT_TIME=$(date -u +'%Y-%m-%d %H:%M UTC')
          TOMORROW=$(date -u -d "+1 day" +%Y-%m-%d 2>/dev/null || date -u -v+1d +%Y-%m-%d)
          NEXT_UPDATE="${TOMORROW} 21:00 UTC"
          CURRENT_DATE_ONLY=$(date -u +%Y-%m-%d)
          
          # Update the task list with latest stats
          cat > REPO_UPDATE_TASKS_TEMP.md <<- 'EOFREPO'
          # ðŸ“‹ Repository Update Tasks

          **Last Updated**: CURRENT_TIME_PLACEHOLDER  
          **Next Update**: NEXT_UPDATE_PLACEHOLDER  
          **Agent**: Repo Update Agent v1.0.0

          ---

          ## â° Next Scheduled Update

          \`\`\`
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  NEXT DOCUMENTATION UPDATE                  â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚  ðŸ“… Date: NEXT_UPDATE_PLACEHOLDER           â”‚
          â”‚  ðŸ• Time: 21:00 UTC (9:00 PM)              â”‚
          â”‚                                             â”‚
          â”‚  Timezone Conversions:                      â”‚
          â”‚  â€¢ 4:00 PM EST (US East)                   â”‚
          â”‚  â€¢ 1:00 PM PST (US West)                   â”‚
          â”‚  â€¢ 10:00 PM CET (Europe)                   â”‚
          â”‚  â€¢ 6:00 AM JST (Japan, next day)           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          \`\`\`

          ---

          ## âœ… Completed Items (Last 24 Hours)

          ### CURRENT_DATE_ONLY_PLACEHOLDER

          | Time (UTC) | Type | Change Description | Files Updated | Commits |
          |------------|------|-------------------|---------------|---------|
          EOFREPO
          
          # Add recent commit info
          if [ -s recent_commits.txt ]; then
            CURRENT_HOUR=$(date -u +%H:%M)
            while IFS= read -r line; do
              echo "| ${CURRENT_HOUR} | Auto | Daily documentation sync | âœ… All targets | $line |" >> REPO_UPDATE_TASKS_TEMP.md
            done < recent_commits.txt
          else
            echo "| - | - | No changes in last 24 hours | - | - |" >> REPO_UPDATE_TASKS_TEMP.md
          fi
          
          cat >> REPO_UPDATE_TASKS_TEMP.md <<- 'EOFREPO2'

          **Total Updates Today**: ${{ steps.commits.outputs.recent_commits }} commits  
          **Agent Status**: âœ… Operational

          ---

          ## ðŸ“Š Current Repository Statistics

          | Metric | Count | Status |
          |--------|-------|--------|
          | **Total Files** | ${{ steps.stats.outputs.total_files }} | âœ… Tracked |
          | **TypeScript Files** | ${{ steps.stats.outputs.ts_files }} | âœ… Active |
          | **Test Files** | ${{ steps.stats.outputs.test_files }} | âœ… Passing |
          | **Documentation Files** | ${{ steps.stats.outputs.doc_files }} | âœ… Comprehensive |
          | **Chrome Extension JS** | ${{ steps.stats.outputs.chrome_js }} | âœ… Production |
          | **Agents** | ${{ steps.stats.outputs.agents }} | âœ… Operational |
          | **MCP Containers** | ${{ steps.stats.outputs.containers }} | âœ… Deployed |
          | **GitHub Workflows** | ${{ steps.stats.outputs.workflows }} | âœ… Active |

          ### Code Metrics

          | Metric | Lines | Status |
          |--------|-------|--------|
          | **Production Code** | ${{ steps.stats.outputs.production_loc }} | âœ… src/ |
          | **Chrome Extension** | ${{ steps.stats.outputs.chrome_loc }} | âœ… chrome-extension/ |
          | **Test Code** | ${{ steps.stats.outputs.test_loc }} | âœ… tests/ |

          ---

          ## ðŸ”„ Rollback Files

          **Latest Backup**: CURRENT_DATE_ONLY_PLACEHOLDER  
          **Location**: \`rollbacks/CURRENT_DATE_ONLY_PLACEHOLDER/\`  
          **Status**: âœ… Available

          ---

          **Managed by**: Repo Update Agent v1.0.0  
          **Next Run**: NEXT_UPDATE_PLACEHOLDER
          EOFREPO2
          
          # Replace placeholders
          sed -i "s/CURRENT_TIME_PLACEHOLDER/$CURRENT_TIME/g" REPO_UPDATE_TASKS_TEMP.md
          sed -i "s/NEXT_UPDATE_PLACEHOLDER/$NEXT_UPDATE/g" REPO_UPDATE_TASKS_TEMP.md
          sed -i "s/CURRENT_DATE_ONLY_PLACEHOLDER/$CURRENT_DATE_ONLY/g" REPO_UPDATE_TASKS_TEMP.md
          
          mv REPO_UPDATE_TASKS_TEMP.md REPO_UPDATE_TASKS.md
      
                - name: Generate update summary
                  run: |
          SUMMARY_DATE=$(date -u +'%Y-%m-%d')
          SUMMARY_TIME=$(date -u +'%Y-%m-%d %H:%M UTC')
          SUMMARY_FILE="repo-update-summary-${SUMMARY_DATE}.md"
          
          cat > "$SUMMARY_FILE" <<- 'EOFSUMMARY'
          # Repo Update Summary - SUMMARY_TIME_PLACEHOLDER

          ## Repository Statistics
          - Total Files: ${{ steps.stats.outputs.total_files }}
          - TypeScript Files: ${{ steps.stats.outputs.ts_files }}
          - Test Files: ${{ steps.stats.outputs.test_files }}
          - Documentation: ${{ steps.stats.outputs.doc_files }}
          - Chrome Extension JS: ${{ steps.stats.outputs.chrome_js }}

          ## Code Metrics
          - Production LOC: ${{ steps.stats.outputs.production_loc }}
          - Chrome Extension LOC: ${{ steps.stats.outputs.chrome_loc }}
          - Test LOC: ${{ steps.stats.outputs.test_loc }}

          ## Infrastructure
          - Agents: ${{ steps.stats.outputs.agents }}
          - MCP Containers: ${{ steps.stats.outputs.containers }}
          - GitHub Workflows: ${{ steps.stats.outputs.workflows }}

          ## Recent Activity
          - Commits (24h): ${{ steps.commits.outputs.recent_commits }}

          ## Updates Applied
          âœ… REPO_UPDATE_TASKS.md - Updated with current statistics
          âœ… Rollback created in rollbacks/SUMMARY_DATE_PLACEHOLDER/

          ## Next Run
          â° NEXT_RUN_PLACEHOLDER
          EOFSUMMARY

          # Pre-calculate next run time
          NEXT_RUN=$(date -u -d 'tomorrow 21:00' +'%Y-%m-%d 21:00 UTC' 2>/dev/null || date -u -v+1d -v21H +'%Y-%m-%d 21:00 UTC')
          
          # Replace placeholders
          sed -i "s/SUMMARY_TIME_PLACEHOLDER/$SUMMARY_TIME/g" "$SUMMARY_FILE"
          sed -i "s/SUMMARY_DATE_PLACEHOLDER/$SUMMARY_DATE/g" "$SUMMARY_FILE"
          sed -i "s/NEXT_RUN_PLACEHOLDER/$NEXT_RUN/g" "$SUMMARY_FILE"
      
      - name: Commit changes
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "Repo Update Agent"
          git config user.email "repo-update-agent@workstation.github.io"
          
          git add REPO_UPDATE_TASKS.md
          git add rollbacks/
          git add repo-update-summary-*.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          COMMIT_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
          ROLLBACK_DATE=$(date -u +%Y-%m-%d)
          
          git commit -m "ðŸ“Š Daily documentation update - ${COMMIT_DATE}

          - Updated REPO_UPDATE_TASKS.md with current statistics
          - Created rollback for ${ROLLBACK_DATE}
          - Total files: ${{ steps.stats.outputs.total_files }}
          - Production LOC: ${{ steps.stats.outputs.production_loc }}
          - Chrome Extension LOC: ${{ steps.stats.outputs.chrome_loc }}
          - Agents: ${{ steps.stats.outputs.agents }}
          - MCP Containers: ${{ steps.stats.outputs.containers }}
          
          Automated by Repo Update Agent v1.0.0"
          
          git push
      
      - name: Dry run output
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "=== DRY RUN MODE ==="
          echo "Changes that would be committed:"
          git diff --staged --stat
          echo ""
          echo "Files that would be updated:"
          git diff --staged --name-only
      
      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: update-summary-${{ github.run_id }}
          path: repo-update-summary-*.md
          retention-days: 30

      - name: Cleanup old rollbacks
        if: github.event.inputs.dry_run != 'true'
        run: |
          # Keep rollbacks for 30 days
          find rollbacks/ -type d -mtime +30 -exec rm -rf {} + 2>/dev/null || true
          
          # Commit cleanup if any files were removed
          if ! git diff --quiet rollbacks/; then
            git add rollbacks/
            git commit -m "ðŸ§¹ Cleanup old rollbacks (30+ days)" || true
            git push || true
          fi
