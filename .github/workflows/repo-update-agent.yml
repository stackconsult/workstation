name: Repo Update Agent - Daily Documentation Sync

on:
  schedule:
    # Runs at 9:00 PM UTC daily (21:00)
    - cron: '0 21 * * *'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      dry_run:
        description: 'Dry run (preview changes without committing)'
        required: false
        default: 'false'
      targets:
        description: 'Specific files to update (comma-separated, or "all")'
        required: false
        default: 'all'
      force_rollback:
        description: 'Force rollback to previous state'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for accurate stats
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        id: install_deps
        continue-on-error: true
        run: |
          npm ci --prefer-offline --no-audit || npm install
          echo "install_status=$?" >> $GITHUB_OUTPUT
      
      - name: Verify installation
        if: steps.install_deps.outputs.install_status != '0'
        run: |
          echo "::error::Dependency installation failed, attempting recovery..."
          rm -rf node_modules package-lock.json
          npm install
      
      - name: Health check
        id: health_check
        run: |
          echo "health_status=healthy" >> $GITHUB_OUTPUT
          if [ ! -f "package.json" ]; then
            echo "::error::Critical file missing: package.json"
            echo "health_status=unhealthy" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Get repository statistics
        id: stats
        continue-on-error: true
        run: |
          set +e  # Don't exit on error
          
          # Wrap each stat collection with error handling
          total_files=$(git ls-files | wc -l) || total_files=0
          ts_files=$(find src -name '*.ts' 2>/dev/null | wc -l) || ts_files=0
          test_files=$(find tests -name '*.test.ts' -o -name '*.spec.ts' 2>/dev/null | wc -l) || test_files=0
          doc_files=$(find . -name '*.md' -not -path './node_modules/*' 2>/dev/null | wc -l) || doc_files=0
          chrome_js=$(find chrome-extension -name '*.js' 2>/dev/null | wc -l) || chrome_js=0
          production_loc=$(find src -name '*.ts' -o -name '*.js' 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}') || production_loc=0
          chrome_loc=$(find chrome-extension -name '*.js' 2>/dev/null | xargs cat | wc -l 2>/dev/null) || chrome_loc=0
          test_loc=$(find tests -name '*.ts' 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}') || test_loc=0
          agents=$(ls -d agents/*/ 2>/dev/null | wc -l) || agents=0
          containers=$(ls -d mcp-containers/*/ 2>/dev/null | wc -l) || containers=0
          workflows=$(ls -1 .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null | wc -l) || workflows=0
          
          # Output with defaults if empty
          echo "total_files=${total_files:-0}" >> $GITHUB_OUTPUT
          echo "ts_files=${ts_files:-0}" >> $GITHUB_OUTPUT
          echo "test_files=${test_files:-0}" >> $GITHUB_OUTPUT
          echo "doc_files=${doc_files:-0}" >> $GITHUB_OUTPUT
          echo "chrome_js=${chrome_js:-0}" >> $GITHUB_OUTPUT
          echo "production_loc=${production_loc:-0}" >> $GITHUB_OUTPUT
          echo "chrome_loc=${chrome_loc:-0}" >> $GITHUB_OUTPUT
          echo "test_loc=${test_loc:-0}" >> $GITHUB_OUTPUT
          echo "agents=${agents:-0}" >> $GITHUB_OUTPUT
          echo "containers=${containers:-0}" >> $GITHUB_OUTPUT
          echo "workflows=${workflows:-0}" >> $GITHUB_OUTPUT
          echo "stats_status=success" >> $GITHUB_OUTPUT
      
      - name: Verify statistics
        if: steps.stats.outputs.stats_status != 'success'
        run: |
          echo "::warning::Statistics collection had issues, using fallback values"
      
      - name: Get recent commits (last 24 hours)
        id: commits
        continue-on-error: true
        run: |
          set +e
          # Calculate 24 hours ago timestamp
          SINCE_TIME=$(date -u -d "24 hours ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-24H +%Y-%m-%dT%H:%M:%SZ)
          COMMIT_COUNT=$(git log --since="$SINCE_TIME" --oneline | wc -l) || COMMIT_COUNT=0
          echo "recent_commits=${COMMIT_COUNT:-0}" >> $GITHUB_OUTPUT
          
          # Get commit messages
          git log --since="$SINCE_TIME" --pretty=format:"- %h: %s" > recent_commits.txt 2>/dev/null || echo "- No recent commits" > recent_commits.txt
          echo "commits_status=success" >> $GITHUB_OUTPUT
      
      - name: Create rollback directory
        id: rollback
        continue-on-error: true
        run: |
          set -e
          ROLLBACK_DATE=$(date -u +%Y-%m-%d)
          ROLLBACK_DIR="rollbacks/${ROLLBACK_DATE}"
          mkdir -p "$ROLLBACK_DIR"
          
          # Backup current documentation with error handling
          for file in README.md REPOSITORY_STATS.md STATS_OVERVIEW.md BUILD_STATISTICS_AND_IMPACT_ANALYSIS.md ACTIVITY_TIMELINE.md ROADMAP_PROGRESS.md REPO_UPDATE_TASKS.md; do
            if [ -f "$file" ]; then
              cp "$file" "$ROLLBACK_DIR/${file}.bak" && echo "âœ… Backed up $file" || echo "âš ï¸ Failed to backup $file"
            else
              echo "âš ï¸ File not found: $file"
            fi
          done
          
          echo "rollback_dir=$ROLLBACK_DIR" >> $GITHUB_OUTPUT
          echo "rollback_status=success" >> $GITHUB_OUTPUT
          echo "âœ… Rollback created in $ROLLBACK_DIR"
      
      - name: Verify rollback creation
        if: steps.rollback.outputs.rollback_status != 'success'
        run: |
          echo "::error::Rollback creation failed!"
          exit 1
      
      - name: Update REPO_UPDATE_TASKS.md
        run: |
          CURRENT_TIME=$(date -u +'%Y-%m-%d %H:%M UTC')
          TOMORROW=$(date -u -d "+1 day" +%Y-%m-%d 2>/dev/null || date -u -v+1d +%Y-%m-%d)
          NEXT_UPDATE="${TOMORROW} 21:00 UTC"
          CURRENT_DATE_ONLY=$(date -u +%Y-%m-%d)
          
          # Update the task list with latest stats
          cat > REPO_UPDATE_TASKS_TEMP.md <<- 'EOFREPO'
          # ðŸ“‹ Repository Update Tasks

          **Last Updated**: CURRENT_TIME_PLACEHOLDER  
          **Next Update**: NEXT_UPDATE_PLACEHOLDER  
          **Agent**: Repo Update Agent v1.0.0

          ---

          ## â° Next Scheduled Update

          \`\`\`
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  NEXT DOCUMENTATION UPDATE                  â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚  ðŸ“… Date: NEXT_UPDATE_PLACEHOLDER           â”‚
          â”‚  ðŸ• Time: 21:00 UTC (9:00 PM)              â”‚
          â”‚                                             â”‚
          â”‚  Timezone Conversions:                      â”‚
          â”‚  â€¢ 4:00 PM EST (US East)                   â”‚
          â”‚  â€¢ 1:00 PM PST (US West)                   â”‚
          â”‚  â€¢ 10:00 PM CET (Europe)                   â”‚
          â”‚  â€¢ 6:00 AM JST (Japan, next day)           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          \`\`\`

          ---

          ## âœ… Completed Items (Last 24 Hours)

          ### CURRENT_DATE_ONLY_PLACEHOLDER

          | Time (UTC) | Type | Change Description | Files Updated | Commits |
          |------------|------|-------------------|---------------|---------|
          EOFREPO
          
          # Add recent commit info
          if [ -s recent_commits.txt ]; then
            CURRENT_HOUR=$(date -u +%H:%M)
            while IFS= read -r line; do
              echo "| ${CURRENT_HOUR} | Auto | Daily documentation sync | âœ… All targets | $line |" >> REPO_UPDATE_TASKS_TEMP.md
            done < recent_commits.txt
          else
            echo "| - | - | No changes in last 24 hours | - | - |" >> REPO_UPDATE_TASKS_TEMP.md
          fi
          
          cat >> REPO_UPDATE_TASKS_TEMP.md <<- 'EOFREPO2'

          **Total Updates Today**: ${{ steps.commits.outputs.recent_commits }} commits  
          **Agent Status**: âœ… Operational

          ---

          ## ðŸ“Š Current Repository Statistics

          | Metric | Count | Status |
          |--------|-------|--------|
          | **Total Files** | ${{ steps.stats.outputs.total_files }} | âœ… Tracked |
          | **TypeScript Files** | ${{ steps.stats.outputs.ts_files }} | âœ… Active |
          | **Test Files** | ${{ steps.stats.outputs.test_files }} | âœ… Passing |
          | **Documentation Files** | ${{ steps.stats.outputs.doc_files }} | âœ… Comprehensive |
          | **Chrome Extension JS** | ${{ steps.stats.outputs.chrome_js }} | âœ… Production |
          | **Agents** | ${{ steps.stats.outputs.agents }} | âœ… Operational |
          | **MCP Containers** | ${{ steps.stats.outputs.containers }} | âœ… Deployed |
          | **GitHub Workflows** | ${{ steps.stats.outputs.workflows }} | âœ… Active |

          ### Code Metrics

          | Metric | Lines | Status |
          |--------|-------|--------|
          | **Production Code** | ${{ steps.stats.outputs.production_loc }} | âœ… src/ |
          | **Chrome Extension** | ${{ steps.stats.outputs.chrome_loc }} | âœ… chrome-extension/ |
          | **Test Code** | ${{ steps.stats.outputs.test_loc }} | âœ… tests/ |

          ---

          ## ðŸ”„ Rollback Files

          **Latest Backup**: CURRENT_DATE_ONLY_PLACEHOLDER  
          **Location**: \`rollbacks/CURRENT_DATE_ONLY_PLACEHOLDER/\`  
          **Status**: âœ… Available

          ---

          **Managed by**: Repo Update Agent v1.0.0  
          **Next Run**: NEXT_UPDATE_PLACEHOLDER
          EOFREPO2
          
          # Replace placeholders
          sed -i "s/CURRENT_TIME_PLACEHOLDER/$CURRENT_TIME/g" REPO_UPDATE_TASKS_TEMP.md
          sed -i "s/NEXT_UPDATE_PLACEHOLDER/$NEXT_UPDATE/g" REPO_UPDATE_TASKS_TEMP.md
          sed -i "s/CURRENT_DATE_ONLY_PLACEHOLDER/$CURRENT_DATE_ONLY/g" REPO_UPDATE_TASKS_TEMP.md
          
          mv REPO_UPDATE_TASKS_TEMP.md REPO_UPDATE_TASKS.md
      
                - name: Generate update summary
                  run: |
          SUMMARY_DATE=$(date -u +'%Y-%m-%d')
          SUMMARY_TIME=$(date -u +'%Y-%m-%d %H:%M UTC')
          SUMMARY_FILE="repo-update-summary-${SUMMARY_DATE}.md"
          
          cat > "$SUMMARY_FILE" <<- 'EOFSUMMARY'
          # Repo Update Summary - SUMMARY_TIME_PLACEHOLDER

          ## Repository Statistics
          - Total Files: ${{ steps.stats.outputs.total_files }}
          - TypeScript Files: ${{ steps.stats.outputs.ts_files }}
          - Test Files: ${{ steps.stats.outputs.test_files }}
          - Documentation: ${{ steps.stats.outputs.doc_files }}
          - Chrome Extension JS: ${{ steps.stats.outputs.chrome_js }}

          ## Code Metrics
          - Production LOC: ${{ steps.stats.outputs.production_loc }}
          - Chrome Extension LOC: ${{ steps.stats.outputs.chrome_loc }}
          - Test LOC: ${{ steps.stats.outputs.test_loc }}

          ## Infrastructure
          - Agents: ${{ steps.stats.outputs.agents }}
          - MCP Containers: ${{ steps.stats.outputs.containers }}
          - GitHub Workflows: ${{ steps.stats.outputs.workflows }}

          ## Recent Activity
          - Commits (24h): ${{ steps.commits.outputs.recent_commits }}

          ## Updates Applied
          âœ… REPO_UPDATE_TASKS.md - Updated with current statistics
          âœ… Rollback created in rollbacks/SUMMARY_DATE_PLACEHOLDER/

          ## Next Run
          â° NEXT_RUN_PLACEHOLDER
          EOFSUMMARY

          # Pre-calculate next run time
          NEXT_RUN=$(date -u -d 'tomorrow 21:00' +'%Y-%m-%d 21:00 UTC' 2>/dev/null || date -u -v+1d -v21H +'%Y-%m-%d 21:00 UTC')
          
          # Replace placeholders
          sed -i "s/SUMMARY_TIME_PLACEHOLDER/$SUMMARY_TIME/g" "$SUMMARY_FILE"
          sed -i "s/SUMMARY_DATE_PLACEHOLDER/$SUMMARY_DATE/g" "$SUMMARY_FILE"
          sed -i "s/NEXT_RUN_PLACEHOLDER/$NEXT_RUN/g" "$SUMMARY_FILE"
      
      - name: Commit changes
        id: commit
        if: github.event.inputs.dry_run != 'true' && github.event.inputs.force_rollback != 'true'
        continue-on-error: true
        run: |
          git config user.name "Repo Update Agent"
          git config user.email "repo-update-agent@workstation.github.io"
          
          git add REPO_UPDATE_TASKS.md
          git add rollbacks/
          git add repo-update-summary-*.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "commit_status=no_changes" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          COMMIT_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
          ROLLBACK_DATE=$(date -u +%Y-%m-%d)
          
          git commit -m "ðŸ“Š Daily documentation update - ${COMMIT_DATE}

          - Updated REPO_UPDATE_TASKS.md with current statistics
          - Created rollback for ${ROLLBACK_DATE}
          - Total files: ${{ steps.stats.outputs.total_files }}
          - Production LOC: ${{ steps.stats.outputs.production_loc }}
          - Chrome Extension LOC: ${{ steps.stats.outputs.chrome_loc }}
          - Agents: ${{ steps.stats.outputs.agents }}
          - MCP Containers: ${{ steps.stats.outputs.containers }}
          
          Automated by Repo Update Agent v1.1.0 (Enhanced with error handling)"
          
          echo "commit_status=success" >> $GITHUB_OUTPUT
      
      - name: Get timestamp
        id: timestamp
        run: |
          echo "datetime=$(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT
          echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request for documentation update
        if: steps.commit.outputs.commit_status == 'success'
        id: pr_create
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto/repo-update-${{ github.run_number }}
          base: main
          commit-message: |
            ðŸ“Š Daily documentation update - ${{ steps.timestamp.outputs.datetime }} [skip ci]
            
            - Updated REPO_UPDATE_TASKS.md with current statistics
            - Created rollback for ${{ steps.timestamp.outputs.date }}
            - Total files: ${{ steps.stats.outputs.total_files }}
            - Production LOC: ${{ steps.stats.outputs.production_loc }}
            - Chrome Extension LOC: ${{ steps.stats.outputs.chrome_loc }}
            - Agents: ${{ steps.stats.outputs.agents }}
            - MCP Containers: ${{ steps.stats.outputs.containers }}
            
            Automated by Repo Update Agent v1.1.0 (Enhanced with error handling)
          title: "ðŸ“Š Daily documentation update [skip ci]"
          body: |
            ## ðŸ“Š Automated Documentation Update
            
            This PR contains automated updates to repository documentation and statistics.
            
            ### Repository Metrics
            - **Total Files**: ${{ steps.stats.outputs.total_files }}
            - **Production LOC**: ${{ steps.stats.outputs.production_loc }}
            - **Chrome Extension LOC**: ${{ steps.stats.outputs.chrome_loc }}
            - **Agents**: ${{ steps.stats.outputs.agents }}
            - **MCP Containers**: ${{ steps.stats.outputs.containers }}
            
            ### Changes Included
            - âœ… Updated `REPO_UPDATE_TASKS.md` with current statistics
            - âœ… Created rollback snapshot for ${{ steps.timestamp.outputs.date }}
            
            ### Rollback Available
            Rollback directory: `rollbacks/${{ steps.timestamp.outputs.date }}/`
            
            ---
            **Auto-generated by**: Repo Update Agent v1.1.0  
            **Workflow**: `.github/workflows/repo-update-agent.yml`  
            **Trigger**: ${{ github.event_name }}
          delete-branch: true
          labels: |
            automated
            documentation
            metrics
            skip-ci
      
      - name: Self-healing rollback on failure
        if: failure() && steps.rollback.outputs.rollback_status == 'success'
        run: |
          echo "::warning::Workflow failure detected, initiating self-healing rollback..."
          ROLLBACK_DIR="${{ steps.rollback.outputs.rollback_dir }}"
          
          if [ -d "$ROLLBACK_DIR" ]; then
            echo "ðŸ“ Restoring files from $ROLLBACK_DIR"
            for backup in "$ROLLBACK_DIR"/*.bak; do
              if [ -f "$backup" ]; then
                original="${backup%.bak}"
                original="${original##*/}"
                cp "$backup" "$original" && echo "âœ… Restored $original" || echo "âŒ Failed to restore $original"
              fi
            done
            
            # Commit rollback
            git config user.name "Repo Update Agent (Recovery)"
            git config user.email "repo-update-agent@workstation.github.io"
            git add -A
            git commit -m "ðŸ”„ Auto-rollback: Restored from backup after workflow failure" || true
            # Direct push for emergency rollback (no PR needed for recovery)
            git push || echo "::warning::Could not push rollback commit"
            
            echo "âœ… Self-healing rollback complete"
          else
            echo "::error::Rollback directory not found: $ROLLBACK_DIR"
          fi
      
      - name: Perform manual rollback
        if: github.event.inputs.force_rollback == 'true'
        run: |
          echo "ðŸ”„ Manual rollback requested"
          YESTERDAY=$(date -u -d "yesterday" +%Y-%m-%d 2>/dev/null || date -u -v-1d +%Y-%m-%d)
          ROLLBACK_DIR="rollbacks/${YESTERDAY}"
          
          if [ -d "$ROLLBACK_DIR" ]; then
            for backup in "$ROLLBACK_DIR"/*.bak; do
              if [ -f "$backup" ]; then
                original="${backup%.bak}"
                original="${original##*/}"
                cp "$backup" "$original" && echo "âœ… Restored $original"
              fi
            done
            
            git config user.name "Repo Update Agent (Manual Rollback)"
            git config user.email "repo-update-agent@workstation.github.io"
            git add -A
            git commit -m "ðŸ”„ Manual rollback to ${YESTERDAY}"
            # Direct push for manual rollback (no PR needed for recovery)
            git push
            
            echo "âœ… Manual rollback complete"
          else
            echo "::error::No rollback found for ${YESTERDAY}"
            exit 1
          fi
      
      - name: Dry run output
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "=== DRY RUN MODE ==="
          echo "Changes that would be committed:"
          git diff --staged --stat || echo "No staged changes"
          echo ""
          echo "Files that would be updated:"
          git diff --staged --name-only || echo "No files changed"
          echo ""
          echo "=== Statistics Summary ==="
          echo "Total Files: ${{ steps.stats.outputs.total_files }}"
          echo "TypeScript Files: ${{ steps.stats.outputs.ts_files }}"
          echo "Test Files: ${{ steps.stats.outputs.test_files }}"
          echo "Agents: ${{ steps.stats.outputs.agents }}"
          echo "MCP Containers: ${{ steps.stats.outputs.containers }}"
      
      - name: Upload summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: update-summary-${{ github.run_id }}
          path: repo-update-summary-*.md
          retention-days: 30
          if-no-files-found: warn

      - name: Cleanup old rollbacks
        if: github.event.inputs.dry_run != 'true' && github.event.inputs.force_rollback != 'true'
        continue-on-error: true
        run: |
          # Keep rollbacks for 30 days
          find rollbacks/ -type d -mtime +30 -exec rm -rf {} + 2>/dev/null || true
          
          # Commit cleanup if any files were removed
          if ! git diff --quiet rollbacks/ 2>/dev/null; then
            git add rollbacks/
            git commit -m "ðŸ§¹ Cleanup old rollbacks (30+ days)" || true
            # Direct push for cleanup (minor maintenance, no PR needed)
            git push || true
          fi
      
      - name: Workflow summary
        if: always()
        run: |
          echo "## ðŸ“Š Repo Update Agent Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Health**: ${{ steps.health_check.outputs.health_status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Statistics**: ${{ steps.stats.outputs.stats_status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commits (24h)**: ${{ steps.commits.outputs.recent_commits }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback**: ${{ steps.rollback.outputs.rollback_status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Repository Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Total Files: ${{ steps.stats.outputs.total_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- Production LOC: ${{ steps.stats.outputs.production_loc }}" >> $GITHUB_STEP_SUMMARY
          echo "- Agents: ${{ steps.stats.outputs.agents }}" >> $GITHUB_STEP_SUMMARY
          echo "- MCP Containers: ${{ steps.stats.outputs.containers }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.push.outputs.push_status }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Changes successfully pushed to repository**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.commit.outputs.commit_status }}" == "no_changes" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ **No changes detected**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Workflow failed - Self-healing rollback initiated**" >> $GITHUB_STEP_SUMMARY
          fi
