events {
    worker_connections 1024;
}

http {
    upstream mcp-backend {
        # All 20 MCP containers
        server mcp-01-selector:3000;
        server mcp-02-navigation:3000;
        server mcp-03-extraction:3000;
        server mcp-04-error-handling:3000;
        server mcp-05-workflow:3000;
        server mcp-06-project-builder:3000;
        server mcp-07-code-quality:3000;
        server mcp-08-performance:3000;
        server mcp-09-error-tracker:3000;
        server mcp-10-security:3000;
        server mcp-11-accessibility:3000;
        server mcp-12-integration:3000;
        server mcp-13-docs-auditor:3000;
        server mcp-14-advanced-automation:3000;
        server mcp-15-api-integration:3000;
        server mcp-16-data-processing:3000;
        server mcp-17-learning-platform:3000;
        server mcp-18-community-hub:3000;
        server mcp-19-deployment:3000;
        server mcp-20-orchestrator:3000;
    }

    # Health check endpoint
    server {
        listen 80;
        server_name _;
        
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

    # MCP routing by agent number
    server {
        listen 80;
        server_name _;
        
        # Route /mcp/01/ to mcp-01-selector
        location ~ ^/mcp/01/(.*)$ {
            proxy_pass http://mcp-01-selector:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        location ~ ^/mcp/02/(.*)$ {
            proxy_pass http://mcp-02-navigation:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/03/(.*)$ {
            proxy_pass http://mcp-03-extraction:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/04/(.*)$ {
            proxy_pass http://mcp-04-error-handling:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/05/(.*)$ {
            proxy_pass http://mcp-05-workflow:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/06/(.*)$ {
            proxy_pass http://mcp-06-project-builder:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/07/(.*)$ {
            proxy_pass http://mcp-07-code-quality:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/08/(.*)$ {
            proxy_pass http://mcp-08-performance:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/09/(.*)$ {
            proxy_pass http://mcp-09-error-tracker:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/10/(.*)$ {
            proxy_pass http://mcp-10-security:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/11/(.*)$ {
            proxy_pass http://mcp-11-accessibility:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/12/(.*)$ {
            proxy_pass http://mcp-12-integration:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/13/(.*)$ {
            proxy_pass http://mcp-13-docs-auditor:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/14/(.*)$ {
            proxy_pass http://mcp-14-advanced-automation:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/15/(.*)$ {
            proxy_pass http://mcp-15-api-integration:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/16/(.*)$ {
            proxy_pass http://mcp-16-data-processing:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/17/(.*)$ {
            proxy_pass http://mcp-17-learning-platform:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/18/(.*)$ {
            proxy_pass http://mcp-18-community-hub:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/19/(.*)$ {
            proxy_pass http://mcp-19-deployment:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location ~ ^/mcp/20/(.*)$ {
            proxy_pass http://mcp-20-orchestrator:3000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # Default fallback
        location / {
            return 404 "Agent not found. Use /mcp/{01-20}/ format\n";
            add_header Content-Type text/plain;
        }
    }
}
